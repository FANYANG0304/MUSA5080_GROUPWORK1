```{r}
# =========================================================
# Step 1: Load libraries and data
# =========================================================
library(readr)
library(dplyr)
library(lubridate)
library(here)
library(tidyr)
library(stringr)

opa_raw <- read_csv("D:/UPENN/MUSA5080/opa_properties_public.csv",
                    na = c("", "NA", "NaN", "NULL"),
                    guess_max = 1e6)

cat("Rows (loaded):", nrow(opa_raw), "\n")
```

```{r}
# =========================================================
# Step 2: Data cleaning and filtering
# =========================================================
opa_res <- opa_raw %>%
  mutate(
    sale_date = as_date(sale_date),
    # ä»·æ ¼ç»Ÿä¸€ä¸ºæ•°å€¼ï¼šæ— è®ºåŸæ¥æ˜¯æ•°å€¼è¿˜æ˜¯å­—ç¬¦ï¼ˆå«$, é€—å·ï¼‰
    sale_price_num = suppressWarnings(
      coalesce(as.numeric(sale_price), readr::parse_number(as.character(sale_price)))
    ),
    # ç±»åˆ«ç»Ÿä¸€ç±»å‹
    cat_chr = as.character(category_code)
  ) %>%
  filter(
    cat_chr %in% c("1"),  
    sale_date >= as_date("2023-01-01"),
    sale_date <= as_date("2024-12-31"),
    sale_price_num >= 10000,
    total_livable_area > 0,
    year_built > 0,
    number_of_bedrooms > 0,
    number_of_bathrooms > 0,
    !is.na(census_tract),
    census_tract != 0,
    census_tract != "",
    !is.na(zip_code),
    zip_code != "",
    !is.na(exterior_condition),
    exterior_condition != "",
    !is.na(interior_condition),
    interior_condition != "",
    !is.na(shape),
    shape != ""
  ) %>%
  select(
    parcel_number, sale_date,
    sale_price = sale_price_num,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract, shape
  ) %>%
  distinct() %>%
  drop_na()

cat("Rows (after cleaning and filtering):", nrow(opa_res), "\n")
```

```{r}
# =========================================================
# Step 3: Extract coordinates from shape field (using sf)
# =========================================================
library(sf)
library(ggplot2)
library(viridis)

# å»æ‰ SRID=2272; å‰ç¼€
wkt <- sub("^SRID=\\d+;\\s*", "", opa_res$shape)

# è½¬æ¢ä¸º sf
geom <- st_as_sfc(wkt, crs = 2272)
opa_sf <- st_sf(opa_res, geometry = geom)

# æå–åæ ‡ï¼ˆç”¨äºæ•£ç‚¹å›¾ï¼‰
coords <- st_coordinates(opa_sf)
opa_sf$X <- coords[, 1]
opa_sf$Y <- coords[, 2]

# è°ƒè¯•è¾“å‡º
cat("Rows with valid coordinates:", nrow(opa_sf), "\n")
cat("Sample X coordinates:", head(opa_sf$X, 3), "\n")
cat("Sample Y coordinates:", head(opa_sf$Y, 3), "\n")
```

```{r}
# =========================================================
# Step 4: Save cleaned data
# =========================================================
# åˆ›å»ºè¾“å‡ºç›®å½•
dir.create(here::here("data"), recursive = TRUE, showWarnings = FALSE)

# å¯¼å‡ºæ•°æ®ï¼ˆç§»é™¤geometryåˆ—ï¼Œåªä¿ç•™åæ ‡ï¼‰
opa_export <- opa_sf %>%
  select(
    parcel_number, sale_date, sale_price,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract, x_coord = X, y_coord = Y
  ) %>%
  st_drop_geometry()  # å¼ºåˆ¶åˆ é™¤geometryåˆ—

write_csv(opa_export, "./data/opa_sales_2023_2024_residential_clean.csv")

cat("Cleaned data saved to: opa_sales_2023_2024_residential_clean.csv\n")
cat("Final dataset contains", nrow(opa_export), "rows with", ncol(opa_export), "columns\n")
cat("Columns:", paste(names(opa_export), collapse = ", "), "\n")
```

```{r}
# =========================================================
# Step 5: Load, clean crime data and calculate crime count for properties
# =========================================================
# ç¡®ä¿å¿…è¦çš„åº“å·²åŠ è½½
library(readr)
library(dplyr)
library(lubridate)
library(here)
library(tidyr)
library(sf)

# åŠ è½½2023å¹´å’Œ2024å¹´çš„çŠ¯ç½ªæ•°æ®
crime_2023 <- read_csv(here("./data/crime_2023.csv"), na = c("", "NA", "NaN", "NULL"), guess_max = 1e6)
crime_2024 <- read_csv(here("./data/crime_2024.csv"), na = c("", "NA", "NaN", "NULL"), guess_max = 1e6)

# åˆå¹¶ã€æ¸…ç†å¹¶å¤„ç†çŠ¯ç½ªæ•°æ®
crime_clean <- bind_rows(
  crime_2023 %>% mutate(year = 2023),
  crime_2024 %>% mutate(year = 2024)
) %>%
  mutate(
    dispatch_date_time = as_datetime(dispatch_date_time),
    dispatch_date = as_date(dispatch_date),
    lat = as.numeric(lat),
    lng = as.numeric(lng),
    point_x = as.numeric(point_x),
    point_y = as.numeric(point_y),
    ucr_general = as.numeric(ucr_general),
    text_general_code = as.character(text_general_code)
  ) %>%
  filter(
    !is.na(lat) & !is.na(lng),
    lat != 0 & lng != 0,
    dispatch_date >= as_date("2023-01-01"),
    dispatch_date <= as_date("2024-12-31")
  ) %>%
  select(
    objectid, dc_dist, psa, dispatch_date_time, dispatch_date, 
    dispatch_time, hour, dc_key, location_block, 
    ucr_general, text_general_code, 
    lat, lng, point_x, point_y, year
  ) %>%
  distinct() %>%
  drop_na()

# åæ ‡è½¬æ¢ï¼šä»WGS84 (4326) è½¬æ¢ä¸º2272åæ ‡ç³»
crime_sf <- crime_clean %>%
  st_as_sf(coords = c("lng", "lat"), crs = 4326) %>%
  st_transform(crs = 2272) %>%
  mutate(
    x_coord_2272 = st_coordinates(.)[, 1],
    y_coord_2272 = st_coordinates(.)[, 2]
  ) %>%
  st_drop_geometry()

# è¯»å–æ¸…ç†åçš„æˆ¿åœ°äº§æ•°æ®
opa_clean <- read_csv(here("./data/opa_sales_2023_2024_residential_clean.csv"))

# å°†æˆ¿åœ°äº§æ•°æ®è½¬æ¢ä¸ºsfå¯¹è±¡ï¼ˆ2272åæ ‡ç³»ï¼‰
opa_sf <- opa_clean %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 2272)

# å°†çŠ¯ç½ªæ•°æ®è½¬æ¢ä¸ºsfå¯¹è±¡ï¼ˆ2272åæ ‡ç³»ï¼‰
crime_sf_spatial <- crime_sf %>%
  st_as_sf(coords = c("x_coord_2272", "y_coord_2272"), crs = 2272)

# ä¸ºæ¯ä¸ªæˆ¿å­åˆ›å»º0.75è‹±é‡Œç¼“å†²åŒºå¹¶è®¡ç®—çŠ¯ç½ªæ•°é‡ï¼ˆ15åˆ†é’Ÿæ­¥è¡Œåœˆï¼‰
opa_buffers <- st_buffer(opa_sf, dist = 3960)  # 0.75 mile = 3960 feet
crime_count <- st_intersects(opa_buffers, crime_sf_spatial)

# å°†çŠ¯ç½ªæ•°é‡æ·»åŠ åˆ°æˆ¿åœ°äº§æ•°æ®ä¸­
opa_with_crime <- opa_clean %>%
  mutate(
    crime_count_15min_walk = sapply(crime_count, length)
  )

cat("çŠ¯ç½ªæ•°æ®å¤„ç†å®Œæˆ:\n")
cat("2023å¹´çŠ¯ç½ªè®°å½•æ•°:", nrow(crime_2023), "\n")
cat("2024å¹´çŠ¯ç½ªè®°å½•æ•°:", nrow(crime_2024), "\n")
cat("æ¸…ç†åæœ‰æ•ˆçŠ¯ç½ªè®°å½•æ•°:", nrow(crime_clean), "\n")
cat("åæ ‡è½¬æ¢åè®°å½•æ•°:", nrow(crime_sf), "\n")
cat("æˆ¿åœ°äº§è®°å½•æ•°:", nrow(opa_with_crime), "\n")
cat("å¹³å‡æ¯ä¸ªæˆ¿å­15åˆ†é’Ÿæ­¥è¡Œåœˆå†…çŠ¯ç½ªæ•°é‡:", round(mean(opa_with_crime$crime_count_15min_walk), 2), "\n")
cat("çŠ¯ç½ªæ•°é‡èŒƒå›´:", min(opa_with_crime$crime_count_15min_walk), "-", max(opa_with_crime$crime_count_15min_walk), "\n")
```

```{r}
# =========================================================
# Step 6: æ·»åŠ å…¬å›­å¯è¾¾æ€§æŒ‡æ ‡ï¼ˆè·ç¦»å•ä½ï¼šè‹±å°ºï¼Œä¿ç•™åæ ‡åˆ—ï¼‰
# =========================================================
library(sf)
library(dplyr)
library(readr)
library(here)

# 1ï¸âƒ£ ä½¿ç”¨ä¸Šä¸€æ­¥çš„çŠ¯ç½ªæ•°æ®å¤„ç†ç»“æœ
opa_with_crime <- opa_with_crime

# è½¬æ¢ä¸º sf å¯¹è±¡ï¼ˆåæ ‡ç³»ä¸º EPSG:2272ï¼Œä»¥è‹±å°ºä¸ºå•ä½ï¼‰
opa_sf <- st_as_sf(
  opa_with_crime,
  coords = c("x_coord", "y_coord"),
  crs = 2272
)

cat("è¯»å–æˆ¿åœ°äº§è®°å½•æ•°:", nrow(opa_sf), "\n")

# 2ï¸âƒ£ è¯»å–å¹¶æŠ•å½±å…¬å›­æ•°æ®
parks <- st_read(here("./data/PPR_Program_Sites.geojson"), quiet = TRUE) %>%
  st_transform(2272)

# 3ï¸âƒ£ è®¡ç®—å…¬å›­å¯è¾¾æ€§æŒ‡æ ‡ï¼ˆå•ä½ï¼šè‹±å°ºï¼‰
opa_sf <- opa_sf %>%
  mutate(
    dist_to_park_ft = apply(st_distance(opa_sf, parks), 1, min),   # æœ€è¿‘å…¬å›­è·ç¦»ï¼ˆè‹±å°ºï¼‰
    park_within_15min_walk = lengths(st_within(opa_sf, st_buffer(parks, 3960)))  # 0.75 mile = 3960 feet (15åˆ†é’Ÿæ­¥è¡Œåœˆ)
  )

# 4ï¸âƒ£ æå–åæ ‡ï¼Œé˜²æ­¢ st_drop_geometry åˆ é™¤
coords <- st_coordinates(opa_sf)
opa_sf <- opa_sf %>%
  mutate(
    x_coord = coords[, 1],
    y_coord = coords[, 2]
  )

# 5ï¸âƒ£ å¯¼å‡ºæ•°æ®ï¼ˆä¿ç•™åæ ‡ä¸æ–°å¢æŒ‡æ ‡ï¼‰
opa_export <- opa_sf %>%
  st_drop_geometry() %>%
  select(
    parcel_number, sale_date, sale_price,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract,
     x_coord, y_coord,                 # âœ… ä¿ç•™åæ ‡
     crime_count_15min_walk,            # çŠ¯ç½ªæ•°é‡
     dist_to_park_ft,                  # æœ€è¿‘å…¬å›­è·ç¦»ï¼ˆè‹±å°ºï¼‰
     park_within_15min_walk            # 15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å…¬å›­æ•°é‡
  )

# 6ï¸âƒ£ è¾“å‡ºæ‘˜è¦ä¿¡æ¯
# ä¿å­˜åŒ…å«å…¬å›­æŒ‡æ ‡çš„å®Œæ•´æ•°æ®
write_csv(opa_export, here("./data/opa_sales_with_parks.csv"))

cat("âœ… å…¬å›­æŒ‡æ ‡å·²æ·»åŠ ï¼ˆå•ä½ï¼šè‹±å°ºï¼‰\n")
cat("  å¹³å‡æœ€è¿‘å…¬å›­è·ç¦»:", round(mean(opa_export$dist_to_park_ft, na.rm = TRUE), 1), "ft\n")
cat("  å¹³å‡15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å…¬å›­æ•°é‡:", round(mean(opa_export$park_within_15min_walk, na.rm = TRUE), 2), "\n")
cat("  å­—æ®µæ•°:", ncol(opa_export), "åˆ—ï¼ˆåŒ…å«åæ ‡åˆ—ï¼‰\n")
cat("ğŸ‰ æ•°æ®å·²ä¿å­˜åˆ°: ./data/opa_sales_with_parks.csv\n")
```

```{r}
# =========================================================
# Step 7: æ·»åŠ å…¬å…±äº¤é€šå¯è¾¾æ€§æŒ‡æ ‡ï¼ˆè·ç¦»æœ€è¿‘å…¬äº¤ç«™ & 1000è‹±å°ºèŒƒå›´å†…å…¬äº¤ç«™æ•°é‡ï¼‰
# =========================================================
library(sf)
library(dplyr)
library(readr)
library(here)
library(units)

# ä½¿ç”¨ç›¸åŒåæ ‡ç³»ï¼ˆEPSG:2272, å•ä½ä¸ºè‹±å°ºï¼‰
analysis_crs <- 2272

# 1ï¸âƒ£ è¯»å–ä¸Šä¸€æ­¥ä¿å­˜çš„æ•°æ®ï¼ˆå¸¦æˆ¿ä»·ã€çŠ¯ç½ªã€å…¬å›­æŒ‡æ ‡ï¼‰
opa_data <- read_csv(here("./data/opa_sales_with_parks.csv"))
opa_sf <- opa_data %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = analysis_crs)

cat("è¯»å–æˆ¿åœ°äº§è®°å½•æ•°:", nrow(opa_sf), "\n")

# 2ï¸âƒ£ è¯»å–å¹¶æŠ•å½±å…¬äº¤ç«™ç‚¹æ•°æ®
transit_path <- here("./data/Transit_Stops_(Spring_2025).geojson")
stopifnot(file.exists(transit_path))

transit_stops <- st_read(transit_path, quiet = TRUE) %>%
  st_transform(analysis_crs) %>%
  suppressWarnings(st_collection_extract("POINT")) %>%
  filter(!st_is_empty(geometry)) %>%
  distinct(geometry, .keep_all = TRUE)

cat("å…¬äº¤ç«™ç‚¹æ•°é‡:", nrow(transit_stops), "\n")

# 3ï¸âƒ£ è®¡ç®—å¯è¾¾æ€§æŒ‡æ ‡ï¼ˆå•ä½ï¼šè‹±å°ºï¼‰
# æœ€è¿‘å…¬äº¤ç«™è·ç¦»
nearest_idx <- st_nearest_feature(opa_sf, transit_stops)
dist_ft <- st_distance(opa_sf, transit_stops[nearest_idx, ], by_element = TRUE)
opa_sf$dist_transit_ft <- as.numeric(set_units(dist_ft, "ft"))

# 15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å…¬äº¤ç«™æ•°é‡
buffer_3960ft <- st_buffer(opa_sf, dist = 3960)  # 0.75 mile = 3960 feet
opa_sf$transit_15min_walk <- lengths(st_intersects(buffer_3960ft, transit_stops))

# 4ï¸âƒ£ æå–åæ ‡ï¼Œé˜²æ­¢ st_drop_geometry åˆ é™¤
coords <- st_coordinates(opa_sf)
opa_sf <- opa_sf %>%
  mutate(
    x_coord = coords[, 1],
    y_coord = coords[, 2]
  )

# 5ï¸âƒ£ å¯¼å‡ºç»“æœï¼ˆä¿ç•™åæ ‡ä¸æ–°å¢æŒ‡æ ‡ï¼‰
opa_export <- opa_sf %>%
  st_drop_geometry() %>%
  select(
    parcel_number, sale_date, sale_price,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract,
     x_coord, y_coord,                 # âœ… ä¿ç•™åæ ‡
     crime_count_15min_walk,            # çŠ¯ç½ªæ•°é‡
     dist_to_park_ft, park_within_15min_walk,# å…¬å›­æŒ‡æ ‡
     dist_transit_ft, transit_15min_walk    # å…¬äº¤æŒ‡æ ‡
  )

# 6ï¸âƒ£ è¾“å‡ºæ‘˜è¦ä¿¡æ¯
# ä¿å­˜åŒ…å«å…¬äº¤æŒ‡æ ‡çš„å®Œæ•´æ•°æ®
write_csv(opa_export, here("./data/opa_sales_with_transit.csv"))

cat("âœ… å…¬å…±äº¤é€šæŒ‡æ ‡å·²æ·»åŠ \n")
cat("  å¹³å‡æœ€è¿‘å…¬äº¤ç«™è·ç¦»:", round(mean(opa_export$dist_transit_ft, na.rm = TRUE), 1), "ft\n")
cat("  å¹³å‡15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å…¬äº¤ç«™æ•°é‡:", round(mean(opa_export$transit_15min_walk, na.rm = TRUE), 2), "\n")
cat("  å­—æ®µæ•°:", ncol(opa_export), "åˆ—ï¼ˆåŒ…å«åæ ‡åˆ—ï¼‰\n")
cat("ğŸ‰ æ•°æ®å·²ä¿å­˜åˆ°: ./data/opa_sales_with_transit.csv\n")

```

```{r}
# =========================================================
# Step 8: æ·»åŠ åŒ»é™¢å¯è¾¾æ€§æŒ‡æ ‡ï¼ˆè·ç¦»æœ€è¿‘åŒ»é™¢ & 500ç±³â‰ˆ1640è‹±å°ºèŒƒå›´å†…åŒ»é™¢æ•°é‡ï¼‰
# =========================================================
library(sf)
library(dplyr)
library(readr)
library(here)

# åæ ‡ç³»ï¼šEPSG 2272ï¼ˆå•ä½ï¼šè‹±å°ºï¼‰
analysis_crs <- 2272

# 1ï¸âƒ£ è¯»å–ä¸Šä¸€æ­¥ä¿å­˜çš„æ•°æ®ï¼ˆå«æˆ¿ä»·ã€çŠ¯ç½ªã€å…¬å›­ã€å…¬äº¤æŒ‡æ ‡ï¼‰
opa_data <- read_csv(here("./data/opa_sales_with_transit.csv"))
opa_sf <- opa_data %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = analysis_crs)

cat("è¯»å–æˆ¿åœ°äº§è®°å½•æ•°:", nrow(opa_sf), "\n")

# 2ï¸âƒ£ è¯»å–åŒ»é™¢æ•°æ®å¹¶æŠ•å½±åˆ°ç›¸åŒåæ ‡ç³»
hospitals <- st_read(here("./data/Hospitals.geojson"), quiet = TRUE) %>%
  st_transform(analysis_crs)

cat("åŒ»é™¢æ•°é‡:", nrow(hospitals), "\n")

# 3ï¸âƒ£ è®¡ç®—åŒ»é™¢å¯è¾¾æ€§æŒ‡æ ‡ï¼ˆå•ä½ï¼šè‹±å°ºï¼‰
opa_sf <- opa_sf %>%
  mutate(
    # æœ€è¿‘åŒ»é™¢è·ç¦»ï¼ˆè‹±å°ºï¼‰
    dist_to_hospital_ft = as.numeric(apply(st_distance(opa_sf, hospitals), 1, min)),
    # 15åˆ†é’Ÿæ­¥è¡Œåœˆå†…åŒ»é™¢æ•°é‡
    hospitals_15min_walk = lengths(st_within(opa_sf, st_buffer(hospitals, 3960)))  # 0.75 mile = 3960 feet
  )

# 4ï¸âƒ£ æå–åæ ‡ï¼ˆé˜²æ­¢ st_drop_geometry åˆ é™¤ï¼‰
coords <- st_coordinates(opa_sf)
opa_sf <- opa_sf %>%
  mutate(
    x_coord = coords[, 1],
    y_coord = coords[, 2]
  )

# 5ï¸âƒ£ å¯¼å‡ºç»“æœï¼ˆä¿ç•™åæ ‡ä¸æ‰€æœ‰ç‰¹å¾ï¼‰
opa_export <- opa_sf %>%
  st_drop_geometry() %>%
  select(
    parcel_number, sale_date, sale_price,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract,
     x_coord, y_coord,                        # âœ… ä¿ç•™åæ ‡
     crime_count_15min_walk,                  # çŠ¯ç½ªæŒ‡æ ‡
     dist_to_park_ft, park_within_15min_walk, # å…¬å›­æŒ‡æ ‡
     dist_transit_ft, transit_15min_walk,     # å…¬äº¤æŒ‡æ ‡
     dist_to_hospital_ft, hospitals_15min_walk # âœ… åŒ»é™¢æŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰
  )

# 6ï¸âƒ£ è¾“å‡ºæ‘˜è¦ä¿¡æ¯
# ä¿å­˜åŒ…å«åŒ»é™¢æŒ‡æ ‡çš„å®Œæ•´æ•°æ®
write_csv(opa_export, here("./data/opa_sales_with_hospitals.csv"))

cat("âœ… åŒ»é™¢å¯è¾¾æ€§æŒ‡æ ‡å·²æ·»åŠ \n")
cat("  å¹³å‡æœ€è¿‘åŒ»é™¢è·ç¦»:", round(mean(opa_export$dist_to_hospital_ft, na.rm = TRUE), 1), "ft\n")
cat("  å¹³å‡15åˆ†é’Ÿæ­¥è¡Œåœˆå†…åŒ»é™¢æ•°é‡:", round(mean(opa_export$hospitals_15min_walk, na.rm = TRUE), 2), "\n")
cat("  å­—æ®µæ•°:", ncol(opa_export), "åˆ—ï¼ˆåŒ…å«åæ ‡åˆ—ï¼‰\n")
cat("  åŒ…å«æ‰€æœ‰ç‰¹å¾ï¼šæˆ¿åœ°äº§ä¿¡æ¯ + çŠ¯ç½ª + å…¬å›­ + å…¬äº¤ + åŒ»é™¢\n")
cat("ğŸ‰ æ•°æ®å·²ä¿å­˜åˆ°: ./data/opa_sales_with_hospitals.csv\n")

```

```{r}
# =========================================================
# Step 9: Enrich with ACS (Census) Socioeconomic Indicators
# =========================================================
library(sf)
library(dplyr)
library(tidycensus)
library(readr)
library(here)

# ---------------------------------------------------------
# 1ï¸âƒ£ è¯»å–æœ€ç»ˆæˆ¿äº§æ•°æ®ï¼ˆåŒ…å«æ‰€æœ‰å¯è¾¾æ€§æŒ‡æ ‡ï¼‰
# ---------------------------------------------------------
opa_final <- read_csv(here("./data/opa_sales_with_hospitals.csv"))

# è½¬ä¸º sf å¯¹è±¡ï¼ˆç¡®ä¿åæ ‡ç³»ä¸º EPSG:2272ï¼‰
opa_sf <- opa_final %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 2272, remove = FALSE)

cat("è¯»å–æˆ¿äº§è®°å½•æ•°:", nrow(opa_sf), "\n")

# ---------------------------------------------------------
# 2ï¸âƒ£ ä¸‹è½½è´¹åŸå¸‚ 2022 å¹´ ACS æ•°æ®ï¼ˆå¯æ”¹å¹´ä»½ï¼‰
# ---------------------------------------------------------
year_acs <- 2022
census_api_key("86993dedbe98d77b9d79db6b8ba21a7fde55cb91", install = FALSE)

acs_vars <- c(
  total_pop      = "B01003_001",
  median_income  = "B19013_001",
  per_cap_income = "B19301_001",
  below_pov      = "B17001_002",
  edu_total25    = "B15003_001",
  edu_bach       = "B15003_022",
  edu_mast       = "B15003_023",
  edu_prof       = "B15003_024",
  edu_phd        = "B15003_025"
)

phl_acs <- get_acs(
  geography = "tract",
  state = "PA",
  county = "Philadelphia",
  year = year_acs,
  geometry = TRUE,
  output = "wide",
  variables = acs_vars
) %>%
  mutate(
    PCBACHMORE = 100 * ((edu_bachE + edu_mastE + edu_profE + edu_phdE) / edu_total25E),
    PCTPOVERTY = 100 * (below_povE / total_popE)
  ) %>%
  select(geometry, GEOID, total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY)

# ---------------------------------------------------------
# 3ï¸âƒ£ æŠ•å½±å¯¹é½ï¼ˆEPSG:2272ï¼‰
# ---------------------------------------------------------
phl_acs <- st_transform(phl_acs, 2272)

# ---------------------------------------------------------
# 4ï¸âƒ£ ç©ºé—´è¿æ¥ï¼šæˆ¿å±‹è½åœ¨æŸä¸ª tract ä¸­
# ---------------------------------------------------------
opa_joined <- st_join(
  opa_sf,
  phl_acs,
  join = st_within,
  left = TRUE
)

# ---------------------------------------------------------
# 5ï¸âƒ£ è¾¹ç•Œå¤–æ ·æœ¬ï¼ˆå¶å°”æœ‰ NAï¼‰ç”¨æœ€è¿‘ tract å¡«å……
# ---------------------------------------------------------
missing <- is.na(opa_joined$median_incomeE)
if (any(missing)) {
  idx <- st_nearest_feature(opa_joined[missing, ], phl_acs)
  repl <- phl_acs[idx, ] %>% st_drop_geometry()
  cols <- names(repl)
  opa_joined[missing, cols] <- repl
}

# ---------------------------------------------------------
# 6ï¸âƒ£ å¯¼å‡ºç»“æœ
# ---------------------------------------------------------
opa_export <- opa_joined %>%
  st_drop_geometry() %>%
  select(
    parcel_number, sale_date, sale_price,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract,
    x_coord, y_coord,
    crime_count_15min_walk,              # çŠ¯ç½ª
    dist_to_park_ft, park_within_15min_walk, # å…¬å›­
    dist_transit_ft, transit_15min_walk, # å…¬äº¤
    dist_to_hospital_ft, hospitals_15min_walk, # åŒ»é™¢
    total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY  # ğŸ†• Census
  )

# ä¿å­˜åŒ…å«CensusæŒ‡æ ‡çš„å®Œæ•´æ•°æ®
write_csv(opa_export, here("./data/opa_sales_final_complete.csv"))

cat("âœ… Census ç¤¾ä¼šç»æµæŒ‡æ ‡å·²æ·»åŠ \n")
cat("  å¹³å‡æ”¶å…¥ (USD):", round(mean(opa_export$median_incomeE, na.rm = TRUE), 0), "\n")
cat("  å¹³å‡è´«å›°ç‡ (%):", round(mean(opa_export$PCTPOVERTY, na.rm = TRUE), 2), "\n")
cat("  å¹³å‡æœ¬ç§‘åŠä»¥ä¸Šå­¦å†æ¯”ä¾‹ (%):", round(mean(opa_export$PCBACHMORE, na.rm = TRUE), 2), "\n")
cat("  åŒ…å«æ‰€æœ‰ç‰¹å¾ï¼šæˆ¿ä»· + çŠ¯ç½ª + å…¬å›­ + å…¬äº¤ + åŒ»é™¢ + ç¤¾ä¼šç»æµ\n")
cat("ğŸ‰ æ•°æ®å·²ä¿å­˜åˆ°: ./data/opa_sales_final_complete.csv\n")

```

```{r}
# =========================================================
# Step 10: Add Education Accessibility Indicators (Schools)
# =========================================================
library(sf)
library(dplyr)
library(readr)
library(here)
library(units)

# ---------------------------------------------------------
# 1ï¸âƒ£ è¯»å–ä¸Šä¸€æ­¥ä¿å­˜çš„å®Œæ•´æ•°æ®ï¼ˆåŒ…å« Census ä¸å¯è¾¾æ€§ç‰¹å¾ï¼‰
# ---------------------------------------------------------
opa_data <- read_csv(here("./data/opa_sales_final_complete.csv"))
opa_sf <- opa_data %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 2272, remove = FALSE)

cat("è¯»å–æˆ¿äº§è®°å½•æ•°:", nrow(opa_sf), "\n")
cat("æ•°æ®åˆ—å:", paste(names(opa_sf), collapse = ", "), "\n")

# ---------------------------------------------------------
# 2ï¸âƒ£ è¯»å–å­¦æ ¡æ•°æ®ï¼ˆä»…ä¸€ä¸ªæ–‡ä»¶ï¼‰
# ---------------------------------------------------------
schools <- st_read(here("./data/Schools_Parcels.geojson"), quiet = TRUE) %>%
  st_transform(2272) %>%
  filter(!st_is_empty(geometry))  # è¿‡æ»¤æ‰ç©ºçš„å‡ ä½•ä½“

cat("âœ… å·²åŠ è½½å­¦æ ¡æ•°æ®:", nrow(schools), "æ¡è®°å½•\n")
cat("å­¦æ ¡æ•°æ®åæ ‡ç³»:", st_crs(schools)$input, "\n")
cat("æˆ¿äº§æ•°æ®åæ ‡ç³»:", st_crs(opa_sf)$input, "\n")

# ---------------------------------------------------------
# 3ï¸âƒ£ è®¡ç®—æ•™è‚²å¯è¾¾æ€§æŒ‡æ ‡
# ---------------------------------------------------------
# æœ€è¿‘å­¦æ ¡è·ç¦»ï¼ˆè‹±å°ºï¼‰
cat("å¼€å§‹è®¡ç®—æœ€è¿‘å­¦æ ¡è·ç¦»...\n")
dist_matrix <- st_distance(opa_sf, schools)
cat("è·ç¦»çŸ©é˜µç»´åº¦:", dim(dist_matrix), "\n")
opa_sf$dist_to_nearest_school_ft <- as.numeric(apply(dist_matrix, 1, min))
cat("æœ€è¿‘å­¦æ ¡è·ç¦»è®¡ç®—å®Œæˆï¼ŒèŒƒå›´:", min(opa_sf$dist_to_nearest_school_ft), "-", max(opa_sf$dist_to_nearest_school_ft), "è‹±å°º\n")

# 15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å­¦æ ¡æ•°é‡
cat("å¼€å§‹è®¡ç®—15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å­¦æ ¡æ•°é‡...\n")
buffer_3960ft <- st_buffer(opa_sf, dist = 3960)  # 0.75 mile = 3960 feet
opa_sf$schools_within_15min_walk <- lengths(st_intersects(buffer_3960ft, schools))
cat("15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å­¦æ ¡æ•°é‡è®¡ç®—å®Œæˆï¼ŒèŒƒå›´:", min(opa_sf$schools_within_15min_walk), "-", max(opa_sf$schools_within_15min_walk), "\n")

# ---------------------------------------------------------
# 4ï¸âƒ£ æå–åæ ‡å¹¶ä¿æŒå®Œæ•´åˆ—
# ---------------------------------------------------------
coords <- st_coordinates(opa_sf)
opa_sf <- opa_sf %>%
  mutate(
    x_coord = coords[, 1],
    y_coord = coords[, 2]
  )

# ---------------------------------------------------------
# 5ï¸âƒ£ å¯¼å‡ºå¸¦æ•™è‚²æŒ‡æ ‡çš„å®Œæ•´è¡¨
# ---------------------------------------------------------
opa_export <- opa_sf %>%
  st_drop_geometry() %>%
  select(
    parcel_number, sale_date, sale_price,
    number_of_bedrooms, number_of_bathrooms,
    total_livable_area, year_built,
    zip_code, category_code,
    exterior_condition, interior_condition,
    census_tract,
    x_coord, y_coord,
    crime_count_15min_walk,                  # çŠ¯ç½ª
    dist_to_park_ft, park_within_15min_walk, # å…¬å›­
    dist_transit_ft, transit_15min_walk,     # å…¬äº¤
    dist_to_hospital_ft, hospitals_15min_walk, # åŒ»é™¢
    total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY,  # Census
    dist_to_nearest_school_ft, schools_within_15min_walk                  # ğŸ†• å­¦æ ¡
  )

# ---------------------------------------------------------
# 6ï¸âƒ£ æ¸…ç†æ•°æ®ï¼šåˆ é™¤æ‰€æœ‰åŒ…å«ç©ºå€¼ã€NAçš„è¡Œ
# ---------------------------------------------------------
# è®°å½•æ¸…ç†å‰çš„è¡Œæ•°
rows_before <- nrow(opa_export)

# åˆ é™¤æ‰€æœ‰åŒ…å«ç©ºå€¼ã€NAçš„è¡Œï¼ˆåŒ…æ‹¬å„ç§å½¢å¼çš„NAï¼‰
# å…ˆå°†å„ç§å½¢å¼çš„ç©ºå€¼è½¬æ¢ä¸ºNA
opa_export <- opa_export %>%
  mutate(across(everything(), ~ {
    if (is.character(.x)) {
      clean_val <- trimws(tolower(as.character(.x)))
      ifelse(clean_val == "" | clean_val == "na" | clean_val == "n/a" | clean_val == "null", 
             NA, .x)
    } else {
      .x
    }
  })) %>%
  # ç„¶ååˆ é™¤ä»»ä½•åˆ—åŒ…å«NAçš„è¡Œ
  drop_na()

# è®°å½•æ¸…ç†åçš„è¡Œæ•°
rows_after <- nrow(opa_export)
rows_removed <- rows_before - rows_after

# ä¿å­˜æ¸…ç†åçš„æ•°æ®
write_csv(opa_export, here("./data/opa_sales_final_complete.csv"))

cat("âœ… æ•™è‚²è®¾æ–½å¯è¾¾æ€§æŒ‡æ ‡å·²æ·»åŠ \n")
cat("  å¹³å‡æœ€è¿‘å­¦æ ¡è·ç¦»:", round(mean(opa_export$dist_to_nearest_school_ft, na.rm = TRUE), 1), "ft\n")
cat("  å¹³å‡15åˆ†é’Ÿæ­¥è¡Œåœˆå†…å­¦æ ¡æ•°é‡:", round(mean(opa_export$schools_within_15min_walk, na.rm = TRUE), 2), "\n")
cat("ğŸ§¹ æ•°æ®æ¸…ç†å®Œæˆï¼šåˆ é™¤äº†", rows_removed, "è¡ŒåŒ…å«ç©ºå€¼æˆ–NAçš„è®°å½•\n")
cat("  æ¸…ç†å‰:", rows_before, "è¡Œ â†’ æ¸…ç†å:", rows_after, "è¡Œ\n")
cat("ğŸ‰ æœ€ç»ˆå®Œæ•´æ•°æ®å·²ä¿å­˜åˆ°: ./data/opa_sales_final_complete.csv\n")
cat("  åŒ…å«æ‰€æœ‰ç‰¹å¾ï¼šæˆ¿ä»· + çŠ¯ç½ª + å…¬å›­ + å…¬äº¤ + åŒ»é™¢ + Census + å­¦æ ¡\n")
cat("  å­—æ®µæ•°:", ncol(opa_export), "åˆ—ï¼ˆåŒ…å«åæ ‡åˆ—ï¼‰\n")

```
